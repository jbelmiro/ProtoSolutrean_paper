---
title: "Supplementary material"
output: 
  pdf_document: 
    latex_engine: xelatex
---

```{r setup, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE
  )
```

```{r callpackages, include=FALSE}

# Call packages
library(readr)
library(dplyr)
library(stringr)
library(tidyr)
library(knitr)
library(tab)
library(ggplot2)
library(FactoMineR)
library(factoextra)
library(RcmdrMisc)
library(IDPmisc)
library(forcats)
library(kableExtra)
library(float)
library(janitor)
library(ggpubr)
library(ggExtra)
library(ggsci)
library(ggalluvial)
```

```{r datadictionary, echo=FALSE}
data_dictionary <- read_csv(here::here("analysis/data/raw_data/data_dictionary.csv"))
knitr::kable(head
(data_dictionary [1:4],46),longtable = TRUE, booktabs=TRUE, caption = "Data Dictionary with variables considered in the attributes analysis, including measurement units, allowed vallued, definitions and/or references.") %>% 
  landscape() %>% 
  kable_styling(latex_options = "repeat_header", font_size = 9) %>% 
  column_spec(1, width = "2cm") %>% 
  column_spec(2, width = "3cm") %>%
  column_spec(3, width = "6cm") %>% 
  column_spec(4, width = "9cm") 

```

```{r metric, fig.cap="Registered measurements scheme for debitage products and cores. Legend: 1- Maximum length; 2- Distal width; 3- Mesial width; 4- Maximum width; 5- Proximal width; 6- Mesial thickness; 7- Platform thickness; 8- Platform width.", out.width = '60%', fig.align='center', echo=FALSE}

knitr::include_graphics(here::here("analysis/figures/Metrics-01.png"))

```

```{r vbmap, fig.cap="Vale Boi. Location.",fig.align='center', out.width = '60%', echo=FALSE}

knitr::include_graphics(here::here("analysis/figures/vale_boi_map.png"))

```

```{r vbphoto, fig.cap="Vale Boi. Topographic plan, schematic profile and general view, with location of the excavation loci. After Cascalheira et al. (2017).", fig.align='center', out.width = '60%', echo=FALSE}

knitr::include_graphics(here::here("analysis/figures/vb_plan.png"))

```

```{r layertable, include=FALSE}

layers_table <- read_csv(here::here("analysis/data/raw_data/VBlayers_table.csv"))
layers_table <- layers_table %>%
  na.omit()

```

```{r vbstrat, echo=FALSE}

knitr::kable(head(layers_table [1:2], 6),  booktabs = TRUE, caption = "Vale Boi. Terrace identified layers with sediment description.") %>% 
  column_spec(1, bold = T) %>% 
  kable_styling(font_size = 9) %>% 
  column_spec(2, width = "12cm") %>%
  column_spec(1, width = "2cm") %>% 
  kable_styling(latex_options = "hold_position")

```

```{r spatialvbfig, fig.cap="East profile stratigraphy in the Terrace area (above) and distribution of all tridimensionally coordenated lithics in the new excavation area until 2017 (under). Lithis from layers 4E and 5 are coloured in black. Blue crosses represent dolerite artefacts and stars mark the provenance of each radiocarbon date: A - WK-42830; B - WK-42831; C - WK-44416.", fig.align='center',out.width = '70%', echo=FALSE, fig.pos="H"}

knitr::include_graphics(here::here("analysis/figures/SpatialanalysisVB.png"))

```

```{r VB_analysis_setup, include=FALSE}

# Read db
context <- read_csv(here::here("analysis/data/raw_data/context.csv")) #Field DB
xyz <- read_csv(here::here("analysis/data/raw_data/xyz.csv")) #Field DB
lithics <- read_csv(here::here("analysis/data/raw_data/Basedados_VB.csv")) #Analysis DB

# Df cleaning and uniformizing
cols_to_concat <- c("Unit", "ID")
context$ID <- str_squish(context$ID) #remove empty spaces from ID field
xyz$ID <- str_squish(xyz$ID) #remove empty spaces from UNIT field

# Concatenate ID and UNIT variables in one single variable (e.g. A6-100)
context <- context %>%
  unite_(col='id', cols_to_concat, sep="-", remove=FALSE) %>%
  select(id, Spit, Level, Code) %>%
  distinct(id, .keep_all = TRUE)

xyz <- xyz %>%
  dplyr::rename(Unit = UNIT) %>%
  unite_(col='id', cols_to_concat, sep="-", remove=FALSE) %>%
  filter(Suffix == 0) %>%
  select(id, X, Y, Z) %>%
  distinct(id, .keep_all = TRUE)

# Classify complete blanks (into flake or elongated) according to W and L ratio
lithics <- lithics %>%
  dplyr::rename(Unit = UNIT) %>%
  unite_(col='id', cols_to_concat, sep="-", remove=FALSE) %>% 
  mutate(elong = MaxWidth*2-Length) %>% 
  mutate(BlankType = case_when(
    Class == "Blank" & elong > 0 ~ "Flake",
    Class == "Blank" & elong <= 0 ~ "ElongatedProd")) %>% 
  as.data.frame()

# Join both tables and (optionally) write csv with final result
field_data <- full_join(xyz, context, by = "id")

# Join field and lithic tables
dataset <- left_join(lithics, field_data, by = "id")

# Force transform 'dataset' into a data.frame
dataset <- as.data.frame(dataset)

# Attribute phase based on depth (Z)
dataset <- dataset %>% 
  mutate(Phase = case_when(
    Z > 24.1 ~ "Upper 5/4E",
    Z < 24.1 ~ "Lower 5"))


```

```{r lp_analysis_setup, include=FALSE}

lithicslp <- read_csv(here::here("analysis/data/raw_data/Basedados_LP.csv"))
xyzlp <- read_csv(here::here("analysis/data/raw_data/xyzlp.csv"))
cols_to_concat <- c("UNIT", "ID")
xyzlp$ID <- str_squish(xyzlp$ID)

lithicslp <- lithicslp %>% 
  dplyr::rename("UNIT" = "X5") %>% 
  unite_(col='ID', cols_to_concat, sep="-", remove=FALSE)

xyzlp <- xyzlp %>%
  unite_(col='ID', cols_to_concat, sep="-", remove=FALSE) %>%
  filter(SUFFIX == 0) %>%
  select(ID, X, Y, Z) %>%
  distinct(ID, .keep_all = TRUE)

# Classify complete blanks (into flake or elongated) according to W and L ratio
lithicslp <- lithicslp %>%
  mutate(elong = MaxWidth*2-Length) %>% 
  mutate(BlankType = case_when(
    Class == "Blank" & elong > 0 ~ "Flake",
    Class == "Blank" & elong <= 0 ~ "ElongatedProd")) %>% 
  select(-elong)

datasetlp <- left_join(lithicslp, xyzlp, by = "ID")

datasetlp <- as.data.frame(datasetlp)

# Attribute phase based on depth (Z)
datasetlp <- datasetlp %>% 
  mutate(Phase = case_when(
    Z >= 566.9 | Level == "T1" | Level == "T2" | Level == "T3" | Level == "T4" | Level == "T5" ~ "Middle T",
    Z < 566.9 | Level == "T6" | Level == "T7" | Level == "T8" | Level == "U" | Level == "U1" ~ "U/Lower T"))

```

```{r general1, echo=FALSE}


### General table Lower 5
db_phase1 <- dataset %>% 
  filter(Phase=="Lower 5")

table1 <- db_phase1 %>% 
  select(RawMaterial, Class) %>% 
  filter(Class != "Chip") %>% 
  dplyr::group_by(RawMaterial) 


chip_table1 <- db_phase1 %>% 
  filter(Class == "Chip") %>%
  select(RawMaterial, ChipQuantity) %>% 
  na.omit() %>% 
  dplyr::group_by(RawMaterial) %>% 
  dplyr::summarise(ChipQuantity = sum(ChipQuantity)) %>% 
  tidyr::spread(RawMaterial, ChipQuantity) %>% 
  mutate(Class = "Chip") %>% 
  select(Class, Quartz, Chert, Greywacke, 
         Dolerite, Chalcedony, Other)

general_table1 <- table(table1$Class, table1$RawMaterial)
general_table1 <- as.data.frame.matrix(general_table1)
general_table1 <- general_table1 %>% 
  select(Quartz, Chert, Greywacke, 
         Dolerite, Chalcedony, Other) %>% 
  tibble::rownames_to_column()
general_table1 <- dplyr::rename(general_table1, "Class" = "rowname")
general_table1 <- union(general_table1, chip_table1)


general_table1 <- general_table1 %>% 
  mutate("Quartz (%)" = paste0(round(100 * Quartz/sum(Quartz), 2), "%")) %>% 
  mutate("Chert (%)" = paste0(round(100 * Chert/sum(Chert), 2), "%")) %>% 
  mutate("Greywacke (%)" = paste0(round(100 * Greywacke/sum(Greywacke), 2), "%")) %>% 
  mutate("Dolerite (%)" = paste0(round(100 * Dolerite/sum(Dolerite), 2), "%")) %>% 
  mutate("Chalcedony (%)" = paste0(round(100 * Chalcedony/sum(Chalcedony), 2), "%")) %>% 
  mutate("Other (%)" = paste0(round(100 * Other/sum(Other), 2), "%")) %>% 
  select("Class", "Quartz", "Quartz (%)", "Chert", "Chert (%)", "Greywacke", "Greywacke (%)", "Dolerite",
         "Dolerite (%)", "Chalcedony", "Chalcedony (%)", "Other", "Other (%)") %>% 
  dplyr::rename("Quartz (n)" = "Quartz", "Chert (n)" = "Chert", "Greywacke (n)" = "Greywacke", "Dolerite (n)" = "Dolerite",
                "Chalcedony (n)" = "Chalcedony", "Other (n)" = "Other") %>% 
  adorn_totals(where = "col", name = "Total") %>% 
  mutate("Total (%)" = paste0(round(100 * Total/sum(Total), 2), "%")) %>% 
  adorn_totals(where = "row", name = "Total")
  
knitr::kable(head(general_table1[1:15], 12), booktabs=TRUE,caption="Vale Boi - Lower 5. Technological class by raw material.") %>% 
  column_spec(1, bold = T) %>% 
  kable_styling(latex_options = "scale_down") %>% 
  kableExtra::landscape() %>% 
  column_spec(2:5, width = "1cm") %>% 
  column_spec(6:7, width = "2cm") %>% 
  column_spec(8:9, width = "1.5cm") %>% 
  column_spec(10:11, width = "2cm") %>% 
  column_spec(12:15, width = "1cm")

```

```{r general2, fig.cap="General table Upper 5/4E.", echo=FALSE}

### General table for Upper 5/4E

db_phase2 <- dataset %>% 
  filter(Phase=="Upper 5/4E")

table2 <- db_phase2 %>% 
  select(RawMaterial, Class) %>% 
  filter(Class != "Chip") %>% 
  dplyr::group_by(RawMaterial) 


chip_table2 <- db_phase2 %>% 
  filter(Class == "Chip") %>%
  select(RawMaterial, ChipQuantity) %>% 
  na.omit() %>% 
  dplyr::group_by(RawMaterial) %>% 
  dplyr::summarise(ChipQuantity = sum(ChipQuantity)) %>% 
  tidyr::spread(RawMaterial, ChipQuantity) %>% 
  mutate(Class = "Chip")
chip_table2$Dolerite=0
chip_table2$Other=0
chip_table2 <- chip_table2 %>%
  select(Class,Quartz, Chert, Greywacke, 
         Dolerite, Chalcedony, Other)

general_table2 <- table(table2$Class, table2$RawMaterial)
general_table2 <- as.data.frame.matrix(general_table2)
general_table2 <- general_table2 %>% 
  select(Quartz, Chert, Greywacke, 
         Dolerite, Chalcedony, Other) %>% 
  tibble::rownames_to_column()
general_table2 <- dplyr::rename(general_table2, "Class" = "rowname")
general_table2 <- union(general_table2, chip_table2)


general_table2 <- general_table2 %>% 
  mutate("Quartz (%)" = paste0(round(100 * Quartz/sum(Quartz), 2), "%")) %>% 
  mutate("Chert (%)" = paste0(round(100 * Chert/sum(Chert), 2), "%")) %>% 
  mutate("Greywacke (%)" = paste0(round(100 * Greywacke/sum(Greywacke), 2), "%")) %>% 
  mutate("Dolerite (%)" = paste0(round(100 * Dolerite/sum(Dolerite), 2), "%")) %>% 
  mutate("Chalcedony (%)" = paste0(round(100 * Chalcedony/sum(Chalcedony), 2), "%")) %>% 
  mutate("Other (%)" = paste0(round(100 * Other/sum(Other), 2), "%")) %>% 
  select("Class", "Quartz", "Quartz (%)", "Chert", "Chert (%)", "Greywacke", "Greywacke (%)", "Dolerite",
         "Dolerite (%)", "Chalcedony", "Chalcedony (%)", "Other", "Other (%)") %>% 
  dplyr::rename("Quartz (n)" = "Quartz", "Chert (n)" = "Chert", "Greywacke (n)" = "Greywacke", "Dolerite (n)" = "Dolerite",
                "Chalcedony (n)" = "Chalcedony", "Other (n)" = "Other") %>% 
  adorn_totals(where = "col", name = "Total") %>% 
  mutate("Total (%)" = paste0(round(100 * Total/sum(Total), 2), "%")) %>% 
  adorn_totals(where = "row", name = "Total")


knitr::kable(head(general_table2[1:15], 12), booktabs=TRUE,caption="Vale Boi - Upper 5/4E. Technological class by raw material.") %>% 
  column_spec(1, bold = T) %>% 
  kable_styling(latex_options = "scale_down") %>% 
  kableExtra::landscape() %>% 
  column_spec(2:5, width = "1cm") %>% 
  column_spec(6:7, width = "2cm") %>% 
  column_spec(8:9, width = "1.5cm") %>% 
  column_spec(10:11, width = "2cm") %>% 
  column_spec(12:15, width = "1cm")

```

```{r doleritephoto, fig.cap="Dolerite flake removed from a debitage waste piece. Left: ventral side with interior colour and texture of the raw material; Right: dorsal side with patina.", fig.scap="Dolerite flake removed from a debitage waste piece.", out.width = '70%', fig.align='center', echo=FALSE, fig.pos="H"}

knitr::include_graphics(here::here("analysis/figures/doleritephoto.jpg"))

```

```{r coreattributesVB1, echo=FALSE, message=FALSE, warning=FALSE}

# Subset cores and phases
coreAT <- dataset %>% 
  filter(Class=="Core")

coreAT1 <- coreAT %>% 
  filter(Phase=="Lower 5")

core_tablep1 <- tabmulti(coreAT1, "RawMaterial", c("CoreType","NumberCoreFaces", 
                                               "CorePlatform", "MainFaceCoreUse"),
                        ymeasures = c("freq","freq","freq","freq","mean"),
                        p.include = FALSE,
                        n.headings = FALSE,
                        bold.varnames = TRUE,
                        bold.colnames = TRUE,
                        variable.colname = "Tecnological attributes")
core_tablep1 <- as.data.frame(core_tablep1)
core_tablep1 <- core_tablep1 %>% 
  select("Tecnological attributes", "Quartz", "Chert","Greywacke","Other")

knitr::kable(core_tablep1, longtable= TRUE, booktabs = TRUE, caption = "Vale Boi - Lower 5 - core attributes frequencies.") %>% 
  row_spec(0, bold = T, align = "c") %>% 
  kable_styling(font_size = 9, latex_options = "repeat_header")

```

\newpage

```{r coreattributesVB2, echo=FALSE, message=FALSE, warning=FALSE}

coreAT2 <- coreAT %>% 
  filter(Phase=="Upper 5/4E")

core_tablep2 <- tabmulti(coreAT2, "RawMaterial", c("CoreType","NumberCoreFaces",
                                               "CorePlatform", "MainFaceCoreUse"),
                        ymeasures = c("freq","freq", "freq","freq"),
                        p.include = FALSE,
                        n.headings = FALSE,
                        bold.varnames = TRUE,
                        bold.colnames = TRUE,
                        variable.colname = "Tecnological attributes")

core_tablep2 <- core_tablep2 %>% 
  as.data.frame() %>% 
  dplyr::rename("Total" =  "Overall") %>% 
  select("Tecnological attributes", "Quartz", "Chert","Other", "Total")


knitr::kable(core_tablep2, longtable= TRUE, booktabs = TRUE, caption = "Vale Boi - Upper 5/4E - core attributes frequencies.") %>% 
  row_spec(0, bold = T, align = "c") %>% 
  kable_styling(position = "center", font_size = 9, latex_options = c("repeat_header", "hold_position"))

```

```{r coretypeVB, echo = FALSE, fig.cap = "Vale Boi. Interaction of core type with type of extracted products by raw material and phase.", fig.align= 'center', out.width = '90%', fig.pos="H"}
cores <- dataset %>% 
  filter(Class == "Core" & !CoreType %in% c("Inform", "Other") & RawMaterial %in% c("Chert", "Quartz")) %>% 
  dplyr::group_by(Phase, RawMaterial, CoreType, MainFaceCoreUse) %>% 
  dplyr::summarise(N = n())
ggplot(data = cores,
       aes(axis1 = CoreType, axis2 = MainFaceCoreUse,
           y = N)) +
  scale_x_discrete(limits = c("Class", "MainFaceCoreUse"), expand = c(.1, .05)) +
  xlab("") +
  geom_alluvium(aes(fill = Phase)) +
  geom_stratum() + 
  geom_text(stat = "stratum", infer.label = TRUE, size = 2) +
  theme_minimal() +
  scale_fill_jco() +
  facet_wrap("RawMaterial") +
  ggtitle("")  +
  theme(legend.position="bottom")
```

```{r corebloxplotVB, fig.cap="Vale Boi. Boxplots of core elongation and flattening by raw material and phase.", out.width='80%', fig.align='center', echo=FALSE}

coreB <- dataset %>% 
  filter(Class=="Core") %>% 
  mutate(CoreElongation=Length/MaxWidth) %>% 
  mutate(CoreFlattening=MaxWidth/Thickness) %>% 
  mutate(CoreConvergence=MedWidth/DistWidth) %>% 
  filter(RawMaterial!="Chalcedony") %>% ##filter out low representitivity 
  filter(RawMaterial!="Greywacke" | Phase!="Upper 5/4E") %>% 
  filter(RawMaterial!="Other" | Phase!="Lower 5")

core_elongation <- coreB %>% 
  mutate(RawMaterial = factor(RawMaterial, levels = c("Quartz", "Chert","Chalcedony", 
                                                      "Greywacke", "Other"))) %>%
  ggplot(aes(x=RawMaterial, y=CoreElongation, fill = Phase)) + 
  geom_boxplot(outlier.shape = NA) +
  theme_minimal() + #type of theme
  theme(legend.title = element_blank()) +
  labs(x = " ", y = "Elongation") +
  theme(axis.title = element_text(size = 10, vjust = -1)) + # x axis size
  scale_fill_jco()+
  geom_point(pch = 21, position = position_jitterdodge(jitter.width = 0.2))


core_flattening <- coreB %>% 
  mutate(RawMaterial = factor(RawMaterial, levels = c("Quartz", "Chert","Chalcedony", 
                                                      "Greywacke", "Other"))) %>%
  ggplot(aes(x=RawMaterial, y=CoreFlattening, fill = Phase)) + 
  geom_boxplot(outlier.shape = NA) +
  theme_minimal() + #type of theme
  theme(legend.title = element_blank()) +
  labs(x = " ", y = "Flattening") +
  theme(axis.title = element_text(size = 10, vjust = -1)) + # x axis size
  scale_fill_jco()+
  geom_point(pch = 21, position = position_jitterdodge(jitter.width = 0.2))

ggarrange(core_elongation, core_flattening,
          widths = c(8, 8),
          heights = c(10, 10),
          nrow = 2,
          common.legend = TRUE,
          legend = "right")
```

\newpage

```{r coremetricsVB1, echo=FALSE, message=FALSE, warning=FALSE}

core_metp1 <- tabmulti(coreAT1, "RawMaterial", c("MedWidth", "Length", "Thickness",
                                                 "PlatformWidth","PlatformThickness", 
                                                 "MainFacePlatformAngle", "Weight"),
                      ymeasures = c("mean", "mean", "mean", "mean", "mean", "mean", "mean"),
                      p.include = FALSE,
                      n.headings = FALSE,
                      bold.varnames = TRUE,
                      bold.colnames = TRUE,
                      listwise.deletion = FALSE,
                      variable.colname = "Core metrics")

core_metp1 <- core_metp1 %>% 
  as.data.frame() %>% 
  dplyr::rename("Total" = "Overall") %>% 
  select("Core metrics", "Quartz", "Chert","Greywacke","Other", "Total")

knitr::kable(core_metp1, booktabs=TRUE, caption = "Vale Boi - Lower 5 - mean and standard deviation of core measurements (in mm).") %>% 
  row_spec(0, bold = T, align = "c") %>% 
  kable_styling(latex_options = c("scale_down", "hold_position"), font_size = 9)

```

```{r coremetricsVB2, echo=FALSE, message=FALSE, warning=FALSE}

core_metp2 <- tabmulti(coreAT2, "RawMaterial", c("MedWidth", "Length", "Thickness",
                                                 "PlatformWidth","PlatformThickness", 
                                                 "MainFacePlatformAngle", "Weight"),
                      ymeasures = c("mean", "mean", "mean", "mean", "mean", "mean", "mean"),
                      p.include = FALSE,
                      n.headings = FALSE,
                      bold.varnames = TRUE,
                      bold.colnames = TRUE,
                      listwise.deletion = FALSE,
                      variable.colname = "Core metrics")


core_metp2 <- core_metp2 %>% 
  as.data.frame() %>% 
  dplyr::rename("Total" = "Overall") %>% 
  select("Core metrics", "Quartz", "Chert","Greywacke","Other", "Total")

knitr::kable(core_metp2, booktabs=TRUE, caption = "Vale Boi - Upper 5/4E - mean and standard deviation of core measurements (in mm).") %>% 
  row_spec(0, bold = T, align = "c") %>% 
  kable_styling(latex_options = c("scale_down", "hold_position"), font_size = 9)
  

```

```{r flakeattributeVB1, echo=FALSE, message=FALSE, warning=FALSE}

blanksAT <- dataset %>% 
  filter(BlankType == "Flake")
blanksAT1 <- blanksAT %>% 
  filter(Phase=="Lower 5")


blank_tablep1 <- tabmulti(dataset = blanksAT1,
                          xvarname = "RawMaterial", 
                          yvarname = c("CrossSection", "BlankShape", "Profile",
                                       "BlankTip", "PlatformType", "PlatformCortex",
                                       "ScarCount", "ScarPattern", "Cortex"),
                          ymeasures = c("freq", "freq", "freq", "freq", 
                                        "freq", "freq", "freq", "freq", "freq"),
                          listwise.deletion = FALSE,
                          p.include = FALSE,
                          n.headings = FALSE,
                          variable.colname = "Attributes")

blank_tablep1<- blank_tablep1 %>% 
  as.data.frame() %>% 
  dplyr::rename("Total" = "Overall") %>% 
  select(Attributes, Quartz, Chert, Greywacke, Dolerite, Chalcedony, Other, Total)


knitr::kable(blank_tablep1, longtable= TRUE, booktabs = TRUE, caption = "Vale Boi - Lower 5 - flake attributes frequencies.") %>% 
  row_spec(0, bold = T, align = "c") %>% 
  kable_styling(position = "center", font_size = 9, latex_options = c("repeat_header", "hold_position")) %>% 
  column_spec(1:8, width = "1cm")

```

\newpage

```{r flakeattributeVB2, echo=FALSE, message=FALSE, warning=FALSE}

blanksAT2 <- blanksAT %>% 
  filter(Phase=="Upper 5/4E")

blank_tablep2 <- tabmulti(dataset = blanksAT2,
                          xvarname = "RawMaterial", 
                          yvarname = c("CrossSection", "BlankShape", "Profile",
                                       "BlankTip", "PlatformType", "PlatformCortex",
                                       "ScarCount", "ScarPattern", "Cortex"),
                          ymeasures = c("freq", "freq", "freq", "freq", 
                                        "freq", "freq", "freq", "freq", "freq"),
                          listwise.deletion = FALSE,
                          p.include = FALSE,
                          n.headings = FALSE,
                          variable.colname = "Attributes")

blank_tablep2<- blank_tablep2 %>% 
  as.data.frame() %>% 
  dplyr::rename("Total" = "Overall") %>% 
  select(Attributes, Quartz, Chert, Greywacke, Dolerite, Chalcedony, Other, Total)


knitr::kable(blank_tablep2, longtable= TRUE, booktabs = TRUE, caption = "Vale Boi - Upper 5/4E - flake attributes frequencies.") %>% 
  row_spec(0, bold = T, align = "c") %>% 
  kable_styling(position = "center", font_size = 9, latex_options = c("repeat_header", "hold_position")) %>% 
  column_spec(1:8, width = "1cm")

```

\newpage

```{r flakemetricsVB1, echo=FALSE, message=FALSE, warning=FALSE}

blank_metp1 <- tabmulti(blanksAT1, "RawMaterial", c("MedWidth", "Length",
                                                    "Thickness", "PlatformWidth",
                                                    "PlatformThickness", "ExteriorPlatformAngle"),
                        ymeasures = c("mean", "mean", "mean", "mean", "mean", "mean"),
                        p.include = FALSE,
                        n.headings = FALSE,
                        listwise.deletion = FALSE,
                        bold.varnames = TRUE,
                        bold.colnames = TRUE,
                        variable.colname = "Measurements")

blank_metp1 <- blank_metp1 %>% 
  as.data.frame() %>% 
  dplyr::rename("Total" = "Overall") %>% 
  select(Measurements, Quartz, Chert, Greywacke, Dolerite, Chalcedony, Other, Total)

knitr::kable(blank_metp1, booktabs=TRUE, caption = "Vale Boi - Lower 5 - mean and standard deviation of flake measurements (in mm).") %>% 
  row_spec(0, bold = T, align = "c") %>% 
  kable_styling(latex_options = c("scale_down", "hold_position"), font_size = 9)

```

```{r flakemetricsVB2, echo=FALSE, message=FALSE, warning=FALSE}

blank_metp2 <- tabmulti(blanksAT2, "RawMaterial", c("MedWidth", "Length", 
                                                    "Thickness", "PlatformWidth", "PlatformThickness", "ExteriorPlatformAngle"),
                        ymeasures = c("mean", "mean", "mean", "mean", "mean", "mean"),
                        p.include = FALSE,
                        n.headings = FALSE,
                        bold.varnames = TRUE,
                        bold.colnames = TRUE,
                        listwise.deletion = FALSE,
                        variable.colname = "Measurements")

blank_metp2 <- blank_metp2 %>% 
  as.data.frame %>% 
  dplyr::rename("Total" = "Overall") %>% 
  select(Measurements, Quartz, Chert, Greywacke, Dolerite, Chalcedony, Other, Total)

knitr::kable(blank_metp2, booktabs=TRUE, caption = "Vale Boi - Upper 5/4E - mean and standard deviation of flake measurements (in mm).") %>% 
  row_spec(0, bold = T, align = "c") %>% 
  kable_styling(latex_options = c("scale_down", "hold_position"), font_size = 9)

```

```{r flakeboxplot, fig.cap="Vale Boi. Boxplots of flake elongation and flattening by raw material and phase.", echo=FALSE, fig.align= 'center', out.width = '80%', fig.pos="H"}
  
flakeB <- dataset %>%
  filter(BlankType=="Flake") %>%
  mutate(FlakeElongation=Length/MaxWidth) %>% 
  mutate(FlakeFlattening=MaxWidth/Thickness) %>% 
  select(Phase, RawMaterial, FlakeFlattening, FlakeElongation) %>% 
  filter(FlakeFlattening < 15) %>% # removing 3 outliers which pull the tails up distorting the graph 
  na.omit()

flake_elongation <- flakeB %>% 
  mutate(RawMaterial = factor(RawMaterial, levels = c("Quartz", "Chert", 
                                                      "Greywacke","Dolerite","Chalcedony", "Other"))) %>%
  ggplot(aes(x=RawMaterial, y=FlakeElongation, fill = Phase)) + 
  geom_boxplot() +
  theme_minimal() + #type of theme
  theme(legend.title = element_blank()) +
  labs(x = " ", y = "Elongation") +
  theme(axis.title = element_text(size = 10, vjust = -1)) + # x axis size
  scale_fill_jco() +
  scale_color_jco() 
#  geom_point(pch = 21, position = position_jitterdodge(jitter.width = 0.3))

flake_flattening <- flakeB %>% 
  mutate(RawMaterial = factor(RawMaterial, levels = c("Quartz", "Chert",   "Greywacke","Dolerite","Chalcedony", "Other"))) %>%
  ggplot(aes(x=RawMaterial, y=FlakeFlattening, fill = Phase)) + 
  geom_boxplot() +
  theme_minimal() + #type of theme
  theme(legend.title = element_blank()) +
  labs(x = " ", y = "Flattening") +
  theme(axis.title = element_text(size = 10, vjust = -1)) + # x axis size
  scale_fill_jco()+
  scale_color_jco() 
#  geom_point(pch = 21, position = position_jitterdodge(jitter.width = 0.3))

ggarrange(flake_elongation, flake_flattening,
          widths = c(8, 8),
          heights = c(10, 10),
          nrow = 2,
          common.legend = TRUE,
          legend = "right")
```

\newpage

```{r elongtableVB1, echo = FALSE, message=FALSE, warning=FALSE}

elongAT <- dataset %>% 
  filter(BlankType == "ElongatedProd")
elongAT1 <- elongAT %>% 
  filter(Phase=="Lower 5")


elong_tablep1 <- tabmulti(dataset = elongAT1,
                          xvarname = "RawMaterial", 
                          yvarname = c("CrossSection", "BlankShape", "Profile",
                                       "BlankTip", "PlatformType", "PlatformCortex",
                                       "ScarCount","ScarPattern", "Cortex"),
                          ymeasures = c("freq", "freq", "freq", "freq", 
                                        "freq", "freq", "freq", "freq", "freq"),
                          listwise.deletion = FALSE,
                          p.include = FALSE,
                          n.headings = FALSE,
                          variable.colname = "Attributes")

elong_tablep1<- elong_tablep1 %>% 
  as.data.frame() %>% 
  dplyr::rename("Total" = "Overall") %>% 
  select(Attributes, Quartz, Chert, Greywacke, Chalcedony, Total)


knitr::kable(elong_tablep1, longtable= TRUE, booktabs = TRUE, caption = "Vale Boi - Lower 5 - elongated products attributes frequencies.") %>% 
  row_spec(0, bold = T, align = "c") %>% 
  kable_styling(position = "center", font_size = 9, latex_options = c("repeat_header", "hold_position")) %>% 
  column_spec(1:6, width = "0.8cm")

```

\newpage

```{r elongtableVB2, echo = FALSE, message=FALSE, warning=FALSE}

elongAT2 <- elongAT %>% 
  filter(Phase=="Upper 5/4E")


elong_tablep2 <- tabmulti(dataset = elongAT2,
                          xvarname = "RawMaterial", 
                          yvarname = c("CrossSection", "BlankShape", "Profile",
                                       "BlankTip", "PlatformType", "PlatformCortex",
                                       "ScarCount","ScarPattern", "Cortex"),
                          ymeasures = c("freq", "freq", "freq", "freq", 
                                        "freq", "freq", "freq", "freq", "freq"),
                          listwise.deletion = FALSE,
                          p.include = FALSE,
                          n.headings = FALSE,
                          variable.colname = "Attributes")

elong_tablep2 <- elong_tablep2 %>% 
  as.data.frame() %>% 
  dplyr::rename("Total" = "Overall") %>% 
  select(Attributes, Quartz, Chert, Greywacke, Dolerite, Other, Chalcedony, Total)

knitr::kable(elong_tablep2, longtable= TRUE, booktabs = TRUE, caption = "Vale Boi - Upper 5/4E - elongated products attributes frequencies.") %>% 
  row_spec(0, bold = T, align = "c") %>% 
  kable_styling(position = "center", font_size = 9, latex_options = c("repeat_header", "hold_position")) %>% 
  column_spec(1:8, width = "0.8cm")

```

\newpage

```{r elongmetricsVB1, echo = FALSE, message=FALSE, warning=FALSE}

elong_metp1 <- tabmulti(elongAT1, "RawMaterial", c("MaxWidth", "Length", "Thickness","PlatformWidth", "PlatformThickness", "ExteriorPlatformAngle"),
                          ymeasures = c("mean", "mean", "mean", "mean", "mean", "mean"),
                          p.include = FALSE,
                          n.headings = FALSE,
                          bold.varnames = TRUE,
                          bold.colnames = TRUE,
                          variable.colname = "Measurements")

elong_metp1 <- elong_metp1 %>%
  as.data.frame() %>% 
  select(Measurements, Quartz, Chert, Greywacke)
  
  
knitr::kable(elong_metp1, booktabs=TRUE, caption = "Vale Boi - Lower 5 - mean and standard deviation of elongated products measurements (in mm).") %>% 
  row_spec(0, bold = T, align = "c") %>% 
  kable_styling(font_size = 9, latex_options = c("hold_position"))

```


```{r elongmtericsVB2, echo=FALSE, message=FALSE, warning=FALSE}

elong_metp2 <- tabmulti(elongAT2, "RawMaterial", c("MaxWidth", "Length", "Thickness","PlatformWidth", "PlatformThickness", "ExteriorPlatformAngle"),
                          ymeasures = c("mean", "mean", "mean", "mean", "mean", "mean"),
                          p.include = FALSE,
                          n.headings = FALSE,
                          bold.varnames = TRUE,
                          bold.colnames = TRUE,
                          variable.colname = "Measurements")
elong_metp2 <- as.data.frame(elong_metp2)
elong_metp2 <- elong_metp2 %>% 
  select(Measurements, Quartz, Chert, Greywacke, Dolerite, Chalcedony, Other)


knitr::kable(elong_metp2, booktabs=TRUE, caption = "Vale Boi - Upper 5/4E - mean and standard deviation of elongated products measurements (in mm).") %>% 
  row_spec(0, bold = T, align = "c") %>% 
  kable_styling(latex_options = c("scale_down", "hold_position"), font_size = 9)

```

```{r retouchVB1, echo=FALSE}

retouch1 <- dataset %>% 
  filter(Class == "RetouchedPiece") %>%
  filter(Phase=="Lower 5") %>% 
  select(RawMaterial, RetouchedPieceTypology) %>% 
  dplyr::group_by(RawMaterial)

retouch_table1 <- table(retouch1$RetouchedPieceTypology, retouch1$RawMaterial)
retouch_table1 <- as.data.frame.matrix(retouch_table1)
retouch_table1 <- retouch_table1 %>% 
  select(Quartz, Chert, Greywacke, 
        Chalcedony) %>% 
  tibble::rownames_to_column()
retouch_table1 <- dplyr::rename(retouch_table1, "Typology" = "rowname")

retouched_order <- c("Typology","Endscraper", "Dihedral Burin", "Burin on truncation", "Truncation", "Notch", "Denticulate", "Splintered piece", "Double backed bladelet", "Retouched blade", "Retouched bladelet", "Retouched flake", "Total")

retouch_table1 <- retouch_table1 %>% 
  mutate("Quartz (%)" = paste0(round(100 * Quartz/sum(Quartz), 2), "%")) %>% 
  mutate("Chert (%)" = paste0(round(100 * Chert/sum(Chert), 2), "%")) %>% 
  mutate("Greywacke (%)" = paste0(round(100 * Greywacke/sum(Greywacke), 2), "%")) %>% 
  mutate("Chalcedony (%)" = paste0(round(100 * Chalcedony/sum(Chalcedony), 2), "%")) %>% 
  select("Typology", "Quartz", "Quartz (%)", "Chert", "Chert (%)", "Greywacke", "Greywacke (%)", 
         "Chalcedony", "Chalcedony (%)") %>% 
  dplyr::rename("Quartz (n)" = "Quartz", "Chert (n)" = "Chert", "Greywacke (n)" = "Greywacke",
         "Chalcedony (n)" = "Chalcedony") %>% 
  adorn_totals(where = "col", name = "Total") %>% 
  mutate("Total (%)" = paste0(round(100 * Total/sum(Total), 2), "%")) %>% 
  adorn_totals(where = "row", name = "Total", fill = "100%") %>% 
  as_tibble() %>% 
  slice(match(retouched_order, Typology))

knitr::kable(head(retouch_table1[1:11], 13), booktabs=TRUE, caption = "Vale Boi - Lower 5. Retouched piece typology by raw material.") %>% 
  kable_styling(latex_options = "scale_down") %>%
  column_spec(1, bold = T) %>% 
  column_spec(2:5, width = "1cm") %>% 
  column_spec(6:9, width = "2cm") %>% 
  column_spec(10:11, width = "1cm") %>% 
  landscape()

```

```{r retouchVB2, echo=FALSE}

retouch2 <- dataset %>% 
  filter(Class == "RetouchedPiece") %>%
  filter(Phase=="Upper 5/4E") %>% 
  select(RawMaterial, RetouchedPieceTypology) %>% 
  dplyr::group_by(RawMaterial)

retouch_table2 <- table(retouch2$RetouchedPieceTypology, retouch2$RawMaterial)
retouch_table2 <- as.data.frame.matrix(retouch_table2)
retouch_table2 <- retouch_table2 %>% 
  select(Quartz, Chert, Greywacke, Dolerite,
        Chalcedony) %>% 
  tibble::rownames_to_column()
retouch_table2 <- dplyr::rename(retouch_table2, "Typology" = "rowname")

retouched_order2 <- c("Typology","Endscraper","Carinated endscraper","Perforator-endscraper","Perforator", "Dihedral Burin", "Burin on truncation", "Truncation", "Vale Comprido Point", "Notch", "Denticulate", "Splintered piece","Backed bladelet","Backed bladelet parcial", "Retouched blade", "Retouched bladelet", "Retouched flake", "Total")

retouch_table2 <- retouch_table2 %>% 
  mutate("Quartz (%)" = paste0(round(100 * Quartz/sum(Quartz), 2), "%")) %>% 
  mutate("Chert (%)" = paste0(round(100 * Chert/sum(Chert), 2), "%")) %>% 
  mutate("Greywacke (%)" = paste0(round(100 * Greywacke/sum(Greywacke), 2), "%")) %>%
  mutate("Dolerite (%)" = paste0(round(100 * Dolerite/sum(Dolerite), 2), "%")) %>% 
  mutate("Chalcedony (%)" = paste0(round(100 * Chalcedony/sum(Chalcedony), 2), "%")) %>% 
  select("Typology", "Quartz", "Quartz (%)", "Chert", "Chert (%)", "Greywacke", "Greywacke (%)", "Dolerite", "Dolerite (%)",
         "Chalcedony", "Chalcedony (%)") %>% 
  dplyr::rename("Quartz (n)" = "Quartz", "Chert (n)" = "Chert", "Greywacke (n)" = "Greywacke", "Dolerite (n)" = "Dolerite",
         "Chalcedony (n)" = "Chalcedony") %>% 
  adorn_totals(where = "col", name = "Total") %>% 
  mutate("Total (%)" = paste0(round(100 * Total/sum(Total), 2), "%")) %>% 
  adorn_totals(where = "row", name = "Total", fill = "100%") %>% 
  as_tibble() %>% 
  slice(match(retouched_order2, Typology))

knitr::kable(retouch_table2, booktabs=TRUE, caption = "Vale Boi - Upper 5/4E. Retouched piece typology by raw material.") %>% 
  kable_styling(latex_options = "scale_down") %>% 
  column_spec(1, bold = T) %>%
  column_spec(2:5, width = "1cm") %>% 
  column_spec(6:7, width = "2cm") %>% 
  column_spec(8:9, width = "1.5cm") %>% 
  column_spec(10:11, width = "2cm") %>% 
  column_spec(12:13, width = "1cm") %>% 
  landscape()

```

\newpage

```{r lpmap, fig.cap="Lapa do Picareiro. Location.", fig.align='center', out.width = '60%', echo=FALSE}

knitr::include_graphics(here::here("analysis/figures/picareiro_map.png"))

```

```{r lpcave, fig.cap="Lapa do Picareiro. Generalized cross section showing surface topography, shape of the cave, and area excavated into sedimentary fill. After Benedetti et al. (2019).", fig.align='center', out.width = '60%', fig.pos="H", echo=FALSE}

knitr::include_graphics(here::here("analysis/figures/lp_cross_section.jpg"))

```

```{r lpstrat, echo=FALSE, message=FALSE, warning=FALSE}

lp_strat <- read_csv(here::here("analysis/data/raw_data//lp_strat.csv"))

lp_strat <- lp_strat %>% 
  mutate_if(is.numeric , replace_na, replace = " ")

knitr::kable(head(lp_strat [1:6], 35),  booktabs = TRUE, longtable = TRUE, caption = "Lapa do Picareiro identified layers with sediment description and associated cultural horizons, whenever existent. After Benedetti et al. (2019).") %>% 
  column_spec(1, bold = T, width = "1cm") %>%
  column_spec(2, width = "1cm") %>% 
  column_spec(3, width = "2cm") %>% 
  column_spec(4, width = "3cm") %>% 
  column_spec(5, width = "8cm") %>% 
  column_spec(6, width = "3cm") %>% 
  kable_styling(latex_options = c("repeat_header"), font_size = 9) %>% 
  landscape()
  
```

\begin{landscape}
```{r spatialut, fig.cap="Lapa do Picareiro. Spatial distribution of all plotted artefacts from levels T-U (in grey), lithic artefacts in colours and shapes refering to raw material and class. After Haws et al. (2019).", out.width = '80%', fig.align='center', echo=FALSE}

knitr::include_graphics(here::here("analysis/figures/LPspatial.jpg"))

```
\end{landscape}

```{r general1lp, echo=FALSE}

## General table for U/Lower T
db_phaseTG <- datasetlp %>% 
  filter(Phase == "U/Lower T")

table_TG <- db_phaseTG %>% 
  select(RawMaterial, Class) %>% 
  filter(Class != "Chip") %>% 
  dplyr::group_by(RawMaterial) 

chip_table_TG <- db_phaseTG %>% 
  filter(Class == "Chip") %>%
  select(RawMaterial, ChipQuantity) %>% 
  na.omit() %>% 
  dplyr::group_by(RawMaterial) %>% 
  dplyr::summarise(ChipQuantity = sum(ChipQuantity)) %>% 
  tidyr::spread(RawMaterial, ChipQuantity) %>% 
  mutate(Class = "Chip") %>% 
  select(Class, Quartz, Chert, Other)

general_table_TG <- table(table_TG$Class, table_TG$RawMaterial)
general_table_TG <- as.data.frame.matrix(general_table_TG)
general_table_TG <- general_table_TG %>% 
  select(Quartz, Chert, Other) %>% 
  tibble::rownames_to_column()
general_table_TG <- dplyr::rename(general_table_TG, "Class" = "rowname")
general_table_TG <- union(general_table_TG, chip_table_TG)

general_table_TG <- general_table_TG %>% 
  mutate("Quartz (%)" = paste0(round(100 * Quartz/sum(Quartz), 2), "%")) %>% 
  mutate("Chert (%)" = paste0(round(100 * Chert/sum(Chert), 2), "%")) %>% 
  mutate("Other (%)" = paste0(round(100 * Other/sum(Other), 2), "%")) %>% 
  select("Class", "Quartz", "Quartz (%)", "Chert", "Chert (%)", "Other", "Other (%)") %>% 
  dplyr::rename("Quartz (n)" = "Quartz", "Chert (n)" = "Chert", "Other (n)" = "Other") %>% 
  adorn_totals(where = "col", name = "Total") %>% 
  mutate("Total (%)" = paste0(round(100 * Total/sum(Total), 2), "%")) %>% 
  adorn_totals(where = "row", name = "Total (RM)")

knitr::kable(head(general_table_TG[1:9], 9), booktabs=TRUE,caption="Lapa do Picareiro - U/Lower T. Technological class by raw material.") %>% 
  column_spec(1, bold = T) %>% 
  kable_styling(latex_options = c("scale_down", "hold_position"))

```

```{r general2lp, echo=FALSE}

### Middle T table
db_phasePR <- datasetlp %>% 
  filter(Phase == "Middle T")

table_PR <- db_phasePR %>% 
  select(RawMaterial, Class) %>% 
  filter(Class != "Chip") %>% 
  dplyr::group_by(RawMaterial) 

chip_table_PR <- db_phasePR %>% 
  filter(Class == "Chip") %>%
  select(RawMaterial, ChipQuantity) %>% 
  na.omit() %>% 
  dplyr::group_by(RawMaterial) %>% 
  dplyr::summarise(ChipQuantity = sum(ChipQuantity)) %>% 
  tidyr::spread(RawMaterial, ChipQuantity) %>% 
  mutate(Class = "Chip") %>% 
  select(Class,Quartz, Chert, Other)

general_table_PR <- table(table_PR$Class, table_PR$RawMaterial)
general_table_PR <- as.data.frame.matrix(general_table_PR)
general_table_PR <- general_table_PR %>% 
  select(Quartz, Chert, Other) %>% 
  tibble::rownames_to_column()
general_table_PR <- dplyr::rename(general_table_PR, "Class" = "rowname")
general_table_PR <- union(general_table_PR, chip_table_PR)

general_table_PR <- general_table_PR %>% 
  mutate("Quartz (%)" = paste0(round(100 * Quartz/sum(Quartz), 2), "%")) %>% 
  mutate("Chert (%)" = paste0(round(100 * Chert/sum(Chert), 2), "%")) %>% 
  mutate("Other (%)" = paste0(round(100 * Other/sum(Other), 2), "%")) %>% 
  select("Class", "Quartz", "Quartz (%)", "Chert", "Chert (%)", "Other", "Other (%)") %>% 
  dplyr::rename("Quartz (n)" = "Quartz", "Chert (n)" = "Chert", "Other (n)" = "Other") %>% 
  adorn_totals(where = "col", name = "Total") %>% 
  mutate("Total (%)" = paste0(round(100 * Total/sum(Total), 2), "%")) %>% 
  adorn_totals(where = "row", name = "Total (RM)")

knitr::kable(head(general_table_PR[1:9], 7), booktabs=TRUE,caption="Lapa do Picareiro - Middle T. Technological class by raw material.") %>% 
  column_spec(1, bold = T) %>% 
  kable_styling(latex_options = c("scale_down", "hold_position"))

```

\newpage

```{r coreattributesLP1, echo=FALSE, message=FALSE, warning=FALSE}

# Subset cores and phases
coreATlp <- datasetlp %>% 
  filter(Class=="Core")

coreAT1lp <- coreATlp %>% 
  filter(Phase== "U/Lower T")



core_tablep1lp <- tabmulti(coreAT1lp, "RawMaterial", c("CoreType","NumberCoreFaces", 
                                                         "CorePlatform", "MainFaceCoreUse"),
                        ymeasures = c("freq","freq","freq","freq"),
                        p.include = FALSE,
                        n.headings = FALSE,
                        bold.varnames = TRUE,
                        bold.colnames = TRUE,
                        listwise.deletion = FALSE,
                        variable.colname = "Attributes")

core_tablep1lp <- core_tablep1lp %>% 
  as.data.frame() %>% 
  select(Attributes, "n (%)") %>% 
  dplyr::rename("Quartz n(%)" = "n (%)")

knitr::kable(core_tablep1lp, booktabs = TRUE, caption = "Lapa do Picareiro - U/Lower T - core attributes frequencies.") %>% 
  row_spec(0, bold = T, align = "c") %>% 
  kable_styling(position = "center", font_size = 9, latex_options = c("repeat_header", "hold_position"))

```

```{r coreattributesLP2, echo=FALSE, message=FALSE, warning=FALSE}

coreAT2lp <- coreATlp %>% 
  filter(Phase== "Middle T")

core_tablep2lp <- tabmulti(coreAT2lp, "RawMaterial", c("CoreType","NumberCoreFaces", 
                                                         "CorePlatform", "MainFaceCoreUse"),
                        ymeasures = c("freq","freq","freq","freq"),
                        p.include = FALSE,
                        n.headings = FALSE,
                        bold.varnames = TRUE,
                        bold.colnames = TRUE,
                        listwise.deletion = FALSE,
                        variable.colname = "Attributes")

core_tablep2lp <- core_tablep2lp %>% 
  as.data.frame() %>% 
  select(Attributes, Quartz, Chert, Other, Overall) %>% 
  dplyr::rename("Total" = "Overall")


knitr::kable(core_tablep2lp, booktabs = TRUE, caption = "Lapa do Picareiro - Middle T - core attributes frequencies.") %>% 
  row_spec(0, bold = T, align = "c") %>% 
  kable_styling(position = "center", font_size = 9, latex_options = c("repeat_header", "hold_position"))

```

\newpage

```{r coremetricsLP1, echo=FALSE, message=FALSE, warning=FALSE}

core_metp1lp <- tabmulti(coreAT1lp, "RawMaterial", c("MedWidth", "Length", "Thickness",
                                                 "PlatformWidth","PlatformThickness", 
                                                 "MainFacePlatformAngle", "Weight"),
                      ymeasures = c("mean", "mean", "mean", "mean", "mean", "mean", "mean"),
                      p.include = FALSE,
                      n.headings = FALSE,
                      bold.varnames = TRUE,
                      bold.colnames = TRUE,
                      listwise.deletion = FALSE,
                      variable.colname = "Core metrics")

core_metp1lp <- core_metp1lp %>% 
  as.data.frame() %>% 
  select("Core metrics", "Quartz")

knitr::kable(core_metp1lp, booktabs=TRUE, caption = "Lapa do Picareiro - U/Lower T - mean and standard deviation of core measurements (in mm).") %>% 
  row_spec(0, bold = T, align = "c") %>% 
  kable_styling(position = "center", font_size = 9, latex_options = "hold_position")

```


```{r coremetricsLP2, echo=FALSE, message=FALSE, warning=FALSE}

core_metp2lp <- tabmulti(coreAT2lp, "RawMaterial", c("MedWidth", "Length", "Thickness",
                                                 "PlatformWidth","PlatformThickness", 
                                                 "MainFacePlatformAngle", "Weight"),
                      ymeasures = c("mean", "mean", "mean", "mean", "mean", "mean", "mean"),
                      p.include = FALSE,
                      n.headings = FALSE,
                      bold.varnames = TRUE,
                      bold.colnames = TRUE,
                      listwise.deletion = FALSE,
                      variable.colname = "Core metrics")

core_metp2lp <- core_metp2lp %>% 
  as.data.frame() %>% 
  dplyr::rename("Total" = "Overall") %>% 
  select("Core metrics", "Quartz", "Chert","Other", "Total")

knitr::kable(core_metp2lp, booktabs=TRUE, caption = "Lapa do Picareiro - Middle T - mean and standard deviation of core measurements (in mm).") %>% 
  row_spec(0, bold = T, align = "c") %>% 
  kable_styling(position = "center", font_size = 9, latex_options = "hold_position")

```

```{r coretypeLP, echo = FALSE, fig.cap="Lapa do Picareiro. Interaction of core type with type of extracted products by raw material and phase.", fig.align= 'center', out.width = '60%', fig.pos="H"}
cores_lp <- datasetlp %>% 
  filter(Class == "Core" & !CoreType %in% c("Inform", "Other") & RawMaterial %in% c("Chert", "Quartz")) %>% 
  dplyr::group_by(Phase, RawMaterial, CoreType, MainFaceCoreUse) %>% 
  dplyr::summarise(N = n())
ggplot(cores_lp,
       aes(axis1 = CoreType, axis2 = MainFaceCoreUse,
           y = N)) +
  scale_x_discrete(limits = c("Class", "MainFaceCoreUse"), expand = c(.1, .05)) +
  xlab("") +
  geom_alluvium(aes(fill = Phase)) +
  geom_stratum() + geom_text(stat = "stratum", infer.label = TRUE) +
  theme_minimal() +
  scale_fill_jco() +
  facet_wrap("RawMaterial") +
  ggtitle("") +
  theme(legend.position="bottom")
```

```{r corebloxplotLP, fig.cap="Lapa do Picareiro. Boxplots of core elongation and flattening by raw material and phase.", echo=FALSE, fig.align= 'center', out.width = '60%', fig.pos="H"}
coreB_LP <- datasetlp %>% 
  filter(Class=="Core") %>% 
  mutate(CoreElongation=Length/MaxWidth) %>% 
  mutate(CoreFlattening=MaxWidth/Thickness) %>% 
  mutate(CoreConvergence=MedWidth/DistWidth) %>% 
  filter(RawMaterial %in% c("Quartz", "Chert"))
core_elongation_LP <- coreB_LP %>% 
  mutate(RawMaterial = factor(RawMaterial, levels = c("Quartz", "Chert"))) %>%
  ggplot(aes(x=RawMaterial, y=CoreElongation, fill = Phase)) + 
  geom_boxplot(outlier.shape = NA) +
  theme_minimal() + #type of theme
  theme(legend.title = element_blank()) +
  labs(x = " ", y = "Elongation") +
  theme(axis.title = element_text(size = 10, vjust = -1)) + # x axis size
  geom_point(pch = 21, position = position_jitterdodge(jitter.width = 0.2)) +
  scale_fill_jco()
core_flattening_LP <- coreB_LP %>% 
  mutate(RawMaterial = factor(RawMaterial, levels = c("Quartz", "Chert","Chalcedony", 
                                                      "Greywacke", "Other"))) %>%
  ggplot(aes(x=RawMaterial, y=CoreFlattening, fill = Phase)) + 
  geom_boxplot(outlier.shape = NA) +
  theme_minimal() + #type of theme
  theme(legend.title = element_blank()) +
  labs(x = " ", y = "Flattening") +
  theme(axis.title = element_text(size = 10, vjust = -1)) + # x axis size
  geom_point(pch = 21, position = position_jitterdodge(jitter.width = 0.2)) +
  scale_fill_jco()
ggarrange(core_elongation_LP, core_flattening_LP,
          widths = c(8, 8),
          heights = c(10, 10),
          nrow = 2,
          common.legend = TRUE,
          legend = "right")
```

\newpage

```{r flakeattributesLP1, echo=FALSE, message=FALSE, warning=FALSE}

flakesATlp <- datasetlp %>% 
  filter(BlankType == "Flake")

flakesAT1lp <- flakesATlp %>% 
  filter(Phase == "U/Lower T")


flakes_tablep1lp <- tabmulti(dataset = flakesAT1lp,
                          xvarname = "RawMaterial", 
                          yvarname = c("CrossSection", "BlankShape", "Profile",
                                       "BlankTip", "PlatformType", "PlatformCortex",
                                       "ScarCount","ScarPattern", "Cortex"),
                          ymeasures = c("freq", "freq", "freq", "freq", 
                                        "freq", "freq", "freq", "freq", "freq"),
                          listwise.deletion = FALSE,
                          p.include = FALSE,
                          n.headings = FALSE,
                          variable.colname = "Attributes")

flakes_tablep1lp<- flakes_tablep1lp %>% 
  as.data.frame() %>% 
  dplyr::rename("Total" = "Overall") %>% 
  select(Attributes, Quartz, Chert, Other, Total)


knitr::kable(flakes_tablep1lp, longtable= TRUE, booktabs = TRUE, caption = "Lapa do Picareiro - U/Lower T - flake attributes frequencies.") %>%
  row_spec(0, bold = T, align = "c") %>% 
  kable_styling(position = "center", font_size = 9, latex_options = c("repeat_header", "hold_position"))

```

\newpage

```{r flakeattributesLP2, echo=FALSE, message=FALSE, warning=FALSE}

flakesAT2lp <- flakesATlp %>% 
  filter(Phase == "Middle T")


flakes_tablep2lp <- tabmulti(dataset = flakesAT2lp,
                          xvarname = "RawMaterial", 
                          yvarname = c("CrossSection", "BlankShape", "Profile",
                                       "BlankTip", "PlatformType", "PlatformCortex",
                                       "ScarCount","ScarPattern", "Cortex"),
                          ymeasures = c("freq", "freq", "freq", "freq", 
                                        "freq", "freq", "freq", "freq", "freq"),
                          listwise.deletion = FALSE,
                          p.include = FALSE,
                          n.headings = FALSE,
                          variable.colname = "Attributes")

flakes_tablep2lp <- flakes_tablep2lp %>% 
  as.data.frame() %>% 
  dplyr::rename("Total" = "Overall") %>% 
  select(Attributes, Quartz, Chert, Other, Total)

knitr::kable(flakes_tablep2lp, longtable= TRUE, booktabs = TRUE, caption = "Lapa do Picareiro - Middle T - flake attributes frequencies.") %>% 
  row_spec(0, bold = T, align = "c") %>% 
  kable_styling(position = "center", font_size = 9, latex_options = c("repeat_header", "hold_position")) 

```

\newpage

```{r flakemetricsLP1, echo=FALSE, message=FALSE, warning=FALSE}

flakes_metp1lp <- tabmulti(flakesAT1lp, "RawMaterial", c("MedWidth", "Length",
                                                    "Thickness", "PlatformWidth",
                                                    "PlatformThickness", "ExteriorPlatformAngle"),
                        ymeasures = c("mean", "mean", "mean", "mean", "mean", "mean"),
                        p.include = FALSE,
                        n.headings = FALSE,
                        listwise.deletion = FALSE,
                        bold.varnames = TRUE,
                        bold.colnames = TRUE,
                        variable.colname = "Measurements")

flakes_metp1lp <- flakes_metp1lp %>% 
  as.data.frame() %>% 
  dplyr::rename("Total" = "Overall") %>% 
  select(Measurements, Quartz, Chert, Other, Total)

knitr::kable(flakes_metp1lp, booktabs=TRUE, caption = "Lapa do Picarerio - U/Lower T - mean and standard deviation of flake measurements (in mm).") %>% 
  row_spec(0, bold = T, align = "c") %>% 
  kable_styling(position = "center", font_size = 9, latex_options = "hold_position")

```


```{r flakemetricsLP2, echo=FALSE, message=FALSE, warning=FALSE}

flakes_metp2lp <- tabmulti(flakesAT2lp, "RawMaterial", c("MedWidth", "Length",
                                                    "Thickness", "PlatformWidth",
                                                    "PlatformThickness", "ExteriorPlatformAngle"),
                        ymeasures = c("mean", "mean", "mean", "mean", "mean", "mean"),
                        p.include = FALSE,
                        n.headings = FALSE,
                        listwise.deletion = FALSE,
                        bold.varnames = TRUE,
                        bold.colnames = TRUE,
                        variable.colname = "Measurements")

flakes_metp2lp <- flakes_metp2lp %>% 
  as.data.frame() %>% 
  dplyr::rename("Total" = "Overall") %>% 
  select(Measurements, Quartz, Chert, Other, Total)

knitr::kable(flakes_metp2lp, booktabs=TRUE, caption = "Lapa do Picarerio - Middle T - mean and standard deviation of flake measurements (in mm).") %>% 
  row_spec(0, bold = T, align = "c") %>% 
  kable_styling(position = "center", font_size = 9, latex_options = "hold_position")

```

```{r flakeboxplotLP, fig.cap="Lapa do Picareiro. Flake elongation and flattening by phase and raw material.", echo=FALSE, fig.align= 'center', out.width = '80%'}
  
flakeB_LP <- datasetlp %>%
  filter(BlankType=="Flake") %>% 
  filter(RawMaterial %in% c("Quartz", "Chert")) %>% 
  mutate(FlakeElongation=Length/MaxWidth) %>% 
  mutate(FlakeFlattening=MaxWidth/Thickness) %>% 
  select(Phase, RawMaterial, FlakeFlattening, FlakeElongation) %>% 
  na.omit()

flake_elongation_LP <- flakeB_LP %>% 
  mutate(RawMaterial = factor(RawMaterial, levels = c("Quartz", "Chert", 
                                                      "Greywacke","Dolerite","Chalcedony", "Other"))) %>%
  ggplot(aes(x=RawMaterial, y=FlakeElongation, fill = Phase)) + 
  geom_boxplot() +
  theme_minimal() + #type of theme
  theme(legend.title = element_blank()) +
  labs(x = " ", y = "Elongation") +
  theme(axis.title = element_text(size = 10, vjust = -1)) + # x axis size
  scale_fill_jco()+
  scale_color_jco()

flake_flattening_LP <- flakeB_LP %>% 
  mutate(RawMaterial = factor(RawMaterial, levels = c("Quartz", "Chert",   "Greywacke","Dolerite","Chalcedony", "Other"))) %>%
  ggplot(aes(x=RawMaterial, y=FlakeFlattening, fill = Phase)) + 
  geom_boxplot() +
  theme_minimal() + #type of theme
  theme(legend.title = element_blank()) +
  labs(x = " ", y = "Flattening") +
  theme(axis.title = element_text(size = 10, vjust = -1)) + # x axis size
  scale_fill_jco()+
  scale_color_jco()

ggarrange(flake_elongation_LP, flake_flattening_LP,
          widths = c(8, 8),
          heights = c(10, 10),
          nrow = 2,
          common.legend = TRUE,
          legend = "right")
```

\newpage

```{r elongtableLP1, echo=FALSE, message=FALSE, warning=FALSE}

elongATlp <- datasetlp %>% 
  filter(BlankType=="ElongatedProd")

elongAT1lp <- elongATlp %>% 
  filter(Phase=="U/Lower T") 

elongAT2lp <- elongATlp %>% 
  filter(Phase=="Middle T")

#Elongated attribute table (all variables, by all raw materials)
elong_tablep1lp <- tabmulti(elongAT1lp, "RawMaterial", c("CrossSection", "BlankShape", 
                                                           "Profile", "BlankTip",
                                                         "PlatformType", 
                                                         "PlatformCortex","ScarCount",
                                                         "ScarPattern", "Cortex"),
                        ymeasures = c("freq", "freq", "freq",
                                      "freq","freq","freq","freq","freq", "freq"),
                        p.include = FALSE,
                        n.headings = FALSE,
                        listwise.deletion = FALSE,
                        bold.varnames = TRUE,
                        bold.colnames = TRUE,
                        variable.colname = "Attributes")


elong_tablep1lp <- elong_tablep1lp %>% 
  as.data.frame() %>% 
  select("Attributes", "Quartz", "Chert", "Overall") %>% 
  dplyr::rename("Total" = "Overall")

knitr::kable(elong_tablep1lp, longtable= TRUE, booktabs = TRUE, caption = "Lapa do Picareiro - U/Lower T - elongated blanks attributes frequencies.") %>% 
  row_spec(0, bold = T, align = "c") %>% 
  kable_styling(position = "center", font_size = 9, latex_options = c("repeat_header", "hold_position"))

```

\newpage

```{r elongtableLP2, echo = FALSE, message=FALSE, warning=FALSE}
#Elongated attribute table (all variables, by all raw materials) - Upper 5/4E
elong_tablep2lp <- tabmulti(elongAT2lp, "RawMaterial", c("CrossSection", "BlankShape", 
                                                           "Profile", "BlankTip",
                                                           "PlatformType", "PlatformCortex",
                                                           "ScarCount", "ScarPattern", "Cortex"),
                        ymeasures = c("freq", "freq", "freq", "freq","freq","freq","freq","freq", "freq"),
                        p.include = FALSE,
                        n.headings = FALSE,
                        listwise.deletion = FALSE,
                        bold.varnames = TRUE,
                        bold.colnames = TRUE,
                        variable.colname = "Attributes")
elong_tablep2lp <- as.data.frame(elong_tablep2lp)
elong_tablep2lp <- elong_tablep2lp %>% 
  select("Attributes", "Quartz", "Chert","Overall") %>% 
  dplyr::rename("Total" = "Overall")

knitr::kable(elong_tablep2lp, longtable= TRUE, booktabs = TRUE, caption = "Lapa do Picareiro - Middle T -  elongated blanks attributes frequencies.") %>% 
  row_spec(0, bold = T, align = "c") %>% 
  kable_styling(position = "center", font_size = 9, latex_options = c("repeat_header", "hold_position"))
```

\newpage

```{r elongmetricsLP1, echo = FALSE, message=FALSE, warning=FALSE}
#Elongated metrics (mean) by raw material
elong_metp1lp <- tabmulti(elongAT1lp, "RawMaterial", c("MaxWidth", "Length", "Thickness","PlatformWidth", "PlatformThickness", "ExteriorPlatformAngle"),
                          ymeasures = c("mean", "mean", "mean", "mean", "mean", "mean"),
                          p.include = TRUE,
                          n.headings = FALSE,
                          listwise.deletion = FALSE,
                          bold.varnames = TRUE,
                          bold.colnames = TRUE,
                          variable.colname = "Measurements")
elong_metp1lp <- as.data.frame(elong_metp1lp)
elong_metp1lp <- elong_metp1lp %>% 
  select(Measurements, Quartz, Chert)

knitr::kable(elong_metp1lp, booktabs=TRUE, caption = "Lapa do Picareiro - U/Lower T - mean and standard deviation of elongated blanks measurements (in mm).") %>% 
  row_spec(0, bold = T, align = "c") %>%
  column_spec(1, width = "4cm") %>% 
  column_spec(2, width = "2cm") %>% 
  column_spec(3, width = "2cm") %>%
  kable_styling(latex_options = "hold_position", font_size = 9)

```


```{r elongmetricsLP2, echo=FALSE, message=FALSE, warning=FALSE}

#Elongated metrics (mean) by raw material
elong_metp2lp <- tabmulti(elongAT2lp, "RawMaterial", c("MaxWidth", "Length", "Thickness","PlatformWidth", "PlatformThickness", "ExteriorPlatformAngle"),
                          ymeasures = c("mean", "mean", "mean", "mean", "mean", "mean"),
                          p.include = FALSE,
                          n.headings = FALSE,
                          listwise.deletion = FALSE,
                          bold.varnames = TRUE,
                          bold.colnames = TRUE,
                          variable.colname = "Measurements")
elong_metp2lp <- as.data.frame(elong_metp2lp)
elong_metp2lp <- elong_metp2lp %>% 
  select(Measurements, Quartz, Chert)

knitr::kable(elong_metp2lp, booktabs=TRUE, caption = "Lapa do Picareiro - Middle T - mean and standard deviation of elongated blanks measurements (in mm).") %>% 
  row_spec(0, bold = T, align = "c") %>% 
  kable_styling(latex_options = "hold_position", font_size = 9)

```

```{r retouchLP1, echo=FALSE}

retouch1lp <- datasetlp %>% 
  filter(Class == "RetouchedPiece") %>%
  filter(Phase=="U/Lower T") %>% 
  select(RawMaterial, RetouchedPieceTypology) %>% 
  dplyr::group_by(RawMaterial)


retouch_table1lp <- table(retouch1lp$RetouchedPieceTypology, retouch1lp$RawMaterial)
retouch_table1lp <- as.data.frame.matrix(retouch_table1lp)
retouch_table1lp <- retouch_table1lp %>% 
  select(Quartz, Chert) %>% 
  tibble::rownames_to_column()
retouch_table1lp <- dplyr::rename(retouch_table1lp, "Typology" = "rowname")

retouched_order3 <- c("Typology","Dihedral angle burin", "Notch", "Splintered piece", "Retouched flake")


retouch_table1lp <- retouch_table1lp %>% 
  mutate("Quartz (%)" = paste0(round(100 * Quartz/sum(Quartz), 2), "%")) %>% 
  mutate("Chert (%)" = paste0(round(100 * Chert/sum(Chert), 2), "%")) %>% 
  select("Typology", "Quartz", "Quartz (%)", "Chert", "Chert (%)") %>% 
  dplyr::rename("Quartz (n)" = "Quartz", "Chert (n)" = "Chert") %>% 
  adorn_totals(where = "col", name = "Total") %>% 
  mutate("Total (%)" = paste0(round(100 * Total/sum(Total), 2), "%")) %>% 
  adorn_totals(where = "row", name = "Total") %>% 
  as_tibble() %>% 
  slice(match(retouched_order3, Typology))


knitr::kable(retouch_table1lp, booktabs=TRUE, caption = "Lapa do Picareiro - U/Lower T. Retouched piece typology by raw material.") %>% 
  row_spec(0, bold = T, align = "c") %>% 
  kable_styling(font_size = 9, latex_options = "hold_position")

```

```{r retouchLP2, echo=FALSE}

retouch2lp <- datasetlp %>% 
  filter(Class == "RetouchedPiece") %>%
  filter(Phase=="Middle T") %>% 
  select(RawMaterial, RetouchedPieceTypology) %>% 
  dplyr::group_by(RawMaterial)

retouch_table2lp <- table(retouch2lp$RetouchedPieceTypology, retouch2lp$RawMaterial)
retouch_table2lp <- as.data.frame.matrix(retouch_table2lp)
retouch_table2lp <- retouch_table2lp %>% 
  select(Chert) %>% 
  tibble::rownames_to_column()
retouch_table2lp <- dplyr::rename(retouch_table2lp, "Typology" = "rowname")

retouched_order4 <- c("Typology","Concave truncation", "Vale Comprido point (?)", "Notch", "Retouched flake")

retouch_table2lp <- retouch_table2lp %>% 
  mutate("Chert (%)" = paste0(round(100 * Chert/sum(Chert), 2), "%")) %>% 
  select("Typology", "Chert", "Chert (%)") %>% 
  dplyr::rename("Chert (n)" = "Chert") %>% 
  adorn_totals(where = "col", name = "Total") %>% 
  adorn_totals(where = "row", name = "Total") %>% 
  as_tibble() %>% 
  slice(match(retouched_order4, Typology))

knitr::kable(retouch_table2lp, booktabs=TRUE, caption = "Lapa do Picareiro - Middle T. Retouched piece typology by raw material.") %>% 
  row_spec(0, bold = T, align = "c") %>% 
  kable_styling(font_size = 9, latex_options = "hold_position")

```

